on:
  issues:
    types: [opened] # you can also add reopened, etc. if you want to

permissions:
  issues: write

env:
  DISCORD_GUILD_ID: '1037083515755434005'
  DISCORD_FORUM_CHANNEL_ID: '1469046334375067708'
  DISCORD_MAPPING_REPO: 'shining-man/bsc-discord-mapping'
  DISCORD_MAPPING_DIR: 'mappings'

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout mapping repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DISCORD_MAPPING_REPO }}
          token: ${{ secrets.BSC_DISCORD_MAPPING_SECRET }}
          path: mapping
      - name: Sync mapping repo
        working-directory: mapping
        run: git pull --rebase

      - id: build_message
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const header = `**[${issue.number}] ${issue.title}**\n`;
            const url = `<${issue.html_url}>\n`;
            const max = 2000;
            const bodyRaw = issue.body || '';
            const space = max - header.length - url.length;
            const body =
              bodyRaw.length > space ? `${bodyRaw.slice(0, Math.max(0, space - 3))}...` : bodyRaw;
            const message = `${header}${body}\n${url}`.slice(0, max);
            core.setOutput('message', message);
      - id: create_thread
        uses: actions/github-script@v7
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_MESSAGE: ${{ steps.build_message.outputs.message }}
        with:
          script: |
            const issue = context.payload.issue;
            const name = `[${issue.number}] ${issue.title}`.slice(0, 100);
            const content = process.env.DISCORD_MESSAGE || '';
            const url = `https://discord.com/api/v10/channels/${process.env.DISCORD_FORUM_CHANNEL_ID}/threads`;
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'Authorization': `Bot ${process.env.DISCORD_BOT_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                name,
                message: { content }
              })
            });
            if (!res.ok) {
              const text = await res.text();
              core.setFailed(`Discord API error ${res.status}: ${text}`);
              return;
            }
            const data = await res.json();
            if (!data?.id) {
              core.setFailed('Discord API did not return a thread id.');
              return;
            }
            core.info(`Created forum thread ${data.id}`);
            core.setOutput('thread_id', data.id);

      - name: Update mapping file
        if: steps.create_thread.outputs.thread_id != ''
        env:
          MAPPING_DIR: ${{ env.DISCORD_MAPPING_DIR }}
          REPO_FULL_NAME: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          FORUM_CHANNEL_ID: ${{ env.DISCORD_FORUM_CHANNEL_ID }}
          THREAD_ID: ${{ steps.create_thread.outputs.thread_id }}
        working-directory: mapping
        run: |
          python - <<'PY'
          import json, os, datetime
          mapping_dir = os.environ["MAPPING_DIR"]
          os.makedirs(mapping_dir, exist_ok=True)
          safe_repo = os.environ["REPO_FULL_NAME"].replace("/", "__")
          path = os.path.join(mapping_dir, f"{safe_repo}.json")
          data = {}
          if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)
          key = f'{os.environ["REPO_FULL_NAME"]}#{os.environ["ISSUE_NUMBER"]}'
          now = datetime.datetime.utcnow().isoformat() + "Z"
          data[key] = {
            "forum_channel": os.environ["FORUM_CHANNEL_ID"],
            "thread_id": os.environ["THREAD_ID"],
            "updated_at": now
          }
          with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2, sort_keys=True)
          PY

      - name: Commit mapping file
        if: steps.create_thread.outputs.thread_id != ''
        working-directory: mapping
        run: |
          git config user.email "actions@users.noreply.github.com"
          git config user.name "github-actions"
          git add "${{ env.DISCORD_MAPPING_DIR }}"
          git commit -m "Update Discord mapping" || echo "No changes"
          git push
